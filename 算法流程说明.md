# 优化票据配票算法流程说明

本文档在《建模设计文档.md》的基础上，聚焦描述 `OptimizedTicketMatcher` 的分层求解流程，并对照 `optimized_ticket_matcher_v2.py` 中的主要函数，梳理业务含义与实现细节，便于后续维护与扩展。

---

## 1. 总体概览

算法遵循 "预筛选 ➜ 贪心构建 ➜ 局部优化" 的三阶段分层混合策略：

1. **快速预筛**：缩减候选票据规模，保留满足硬约束且在当前偏好权重下得分较高的票据。
2. **贪心构建**：分轮次逐步挑选票据，使总金额逼近付款单目标，同时满足张数、极小票等约束。
3. **局部优化**：在初步组合基础上通过拆票、交换及库存校准等操作进行微调，进一步提升金额贴合度与综合评分。

整个流程由构造器 `OptimizedTicketMatcher.optimize()` 串联，每个子步骤均对应独立的私有方法，既有良好的模块化结构，也便于根据业务策略调整替换。

---

## 2. 数据准备与评分计算

### 2.1 DataFrame 构建
- **函数**：`_build_dataframe`
- **步骤**：将输入的 `Ticket` 列表转换为 Pandas DataFrame，附带金额、期限、承兑人、所属组织等字段，为后续筛选和评分提供基础结构。

### 2.2 维度评分
- **函数**：`_compute_scores`
- **逻辑**：针对金额、期限、承兑人、组织四个维度，根据 `TargetWeights` 中配置的策略分别生成归一化分值。
  - 金额维度细分策略由 `_compute_amount_score` 执行（例如大额优先、小额优先、库存优化等）。
  - 期限、承兑人、组织维度则根据 `TermStrategy`、`AcceptorStrategy`、`OrganizationStrategy` 切换远近、好坏、同异组织的偏好评分。
- **综合评分**：使用 `w1~w4` 权重线性加权形成 `total_score`，作为排序与贪心挑选的依据。

### 2.3 存量信息
- 若用户启用库存平衡，`_compute_inventory_balance_score` 会结合 `InventoryInfo` 计算各金额类型相对目标占比的偏差，用于优化库存结构。

### 2.4 金额精度
- 为满足财务报告要求，算法通过 `_quantize_float` 等方法统一在输出层使用 `Decimal` 保留两位小数，防止浮点误差。

---

## 3. 阶段一：快速预筛选

- **函数**：`_fast_prefilter`
- **目标**：在满足硬性金额约束（单票上下界、最大张数等）的前提下，保留所有满足约束的票据，再根据综合评分进行排序，为下一阶段的贪心构建做准备。金额策略只参与评分排序，不直接作为过滤条件。
- **输出**：与硬约束兼容的候选 DataFrame，保持完整数据以免在极端场景下丢失潜在解。若需控制规模，可通过额外参数配置，而不是写死 Top-N 限制。

---

## 4. 阶段二：改进贪心构建

- **函数**：`_improved_greedy_construct`
- **策略**：按 `total_score` 由高到低遍历候选票据，分三轮控制目标区间：
  1. **严格轮**：禁止超出目标上界，仅累加金额不超过目标区间上限的票据。
  2. **适度宽松**：允许总金额达到目标的 110%，用于缓解组合过低的情况。
  3. **宽松轮**：放宽至 120%，确保在票据结构较差时仍能找到可行方案。
- **约束控制**：在选入票据时同步检查：
  - 当前已选张数是否超过 `Constraints.max_tickets`；
  - 极小票（金额 < 2×`min_amount`）数量是否跨越 `max_mini_amount_tickets`；
  - 边际收益是否使总金额更接近目标，并避免无谓的大幅偏离。
- **输出**：初步组合的 `Solution`（仍可能存在与目标金额的差异）。

---

## 5. 阶段三：局部优化

### 5.1 拆票优化
- **入口**：`_optimize_split`
- **场景1（金不足）**：若目标差额 `bias_amount` 小于尾差阈值 (`_calculate_tail_threshold`)，允许通过电汇补齐；否则调用 `_split_from_pool` 从未选票据中挑选金额略大的票拆出差额。
- **场景2（金超额）**：调用 `_split_from_current`，在已选组合中拆出多余金额，确保留存金额满足 `Constraints.remain_after_split`。
- **策略选择**：`_select_ticket_by_strategy` 根据拆票策略偏好（期限/承兑人/金额）挑选拆分对象，兼顾业务优先级。
- **输出**：更新后的 `Solution`，包含拆票明细和拆分金额记录。

### 5.2 交换优化
- **函数**：`_swap_optimization`
- **逻辑**：在若干轮迭代中，尝试用未选票据替换当前组合内的低分票，约束替换后金额误差不高于原误差的 1.5 倍。若综合评分提升超过 0.1%，则接受替换。

### 5.3 库存平衡微调
- **函数**：`_balance_inventory`
- **现状**：当前实现仅计算已选票据的类型占比，与 `UserPreference.remain_dist` 对比后暂不作进一步动作（预留扩展）。
- **潜力**：可在此加入基于库存偏差的替换方案，以软约束方式提高库存结构匹配度。

---

## 6. 解构建与评分

### 6.1 Solution 构建
- **函数**：`_create_solution`
- **内容**：
  - 汇总选中票据、拆票明细、拆分金额、留存金额等信息。
  - 计算结构分布（大/中/小票比例）和剩余库存结构。
  - 统一将金额相关字段量化到 2 位小数。

### 6.2 综合得分
- **函数**：`_calc_solution_score`
- **步骤**：
  1. 金额匹配度：基于绝对差额与目标金额计算 `amount_match`。
  2. 各维度均值：对 `amount_score`、`term_score`、`acceptor_score_norm`、`org_score` 取平均。
  3. 库存软约束：若启用库存平衡，调用 `_calc_inventory_balance_score_for_solution` 基于余票占比偏差生成评分，并与主评分按 0.8/0.2 加权。
  4. 返回综合得分及各维度得分细项，便于业务方解释。

### 6.3 余票库存
- **函数**：`_calc_remaining_inventory`
- **用途**：统计被选票据移除后，剩余票据池在大/中/小票上的占比，为库存分析与配票后的补货建议提供依据。

---

## 7. 测试与示例

- `generate_test_data`：生成大规模票据池示例数据，涵盖金额、期限、承兑评分、组织等多维信息。
- `run_example`：串联数据生成、算法执行与结果打印，展示优化效果、拆票细节及分值输出，方便快速回归和演示。
- 单元测试脚本（如 `test_correct_split.py`、`test_split_fix.py`、`test_split_output.py`）进一步验证拆票逻辑、拆票修复以及输出格式。

---

## 8. 与建模设计文档的关系

- 本流程说明对应《建模设计文档.md》中提出的变量体系、约束条件与目标函数，实际实现遵循该建模框架。
- 文档中提及的金额精度控制、拆票策略、库存平衡软约束等关键点均在 `optimized_ticket_matcher_v2.py` 得到落地。
- 后续若扩展库存微调、引入混合整数规划或并行化计算，可在现有函数中按模块化方式替换或追加。

---

## 9. 后续迭代建议（聚焦实现层面）

1. **库存微调增强**：在 `_balance_inventory` 中加入基于库存偏差的替换策略，将库存目标纳入评分提升逻辑。
2. **分布式预筛**：针对超大票据池，考虑在 `_fast_prefilter` 中加入并行排序或分桶策略，加速预筛选处理。
3. **拆票策略多样化**：扩充 `_select_ticket_by_strategy`，支持混合评分（如金额 + 承兑），增强在复杂偏好时的辨识度。
4. **调试日志**：当前 `optimize` 阶段的调试打印可改为可控的日志等级，便于线上环境排查。

---

通过以上说明，新文档将建模过程的抽象设计与代码实现的具体步骤有效衔接，支持团队成员快速理解算法运行机制与核心模块职责。
